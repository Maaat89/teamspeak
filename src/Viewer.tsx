import "@styles/Viewer.scss";
import useTSRemoteApp, { IClient } from "react-ts5-remote-app-api";

export default function Viewer({
  remoteAppPort = 5899,
  showChannelName = false,
  hideNonTalking = false,
  clientLimit = 0,
}: {
  remoteAppPort?: number;
  showChannelName?: boolean;
  hideNonTalking?: boolean;
  clientLimit?: number;
}) {
  const { clients, activeConnectionId, currentChannel } = useTSRemoteApp({
    remoteAppPort: remoteAppPort,
    auth: {
      identifier: "de.tealfire.obs",
      version: "2.1.1",
      name: "TS5 OBS Overlay",
      description: "A OBS overlay for TS5 by DerTyp7",
    },
    logging: true,
  });

  const currentClients = clients.map((client) => {
    if (client.channel?.id === currentChannel?.id && client.channel.connection.id === activeConnectionId) {
      return client;
    }
  }) as IClient[];

  return (
    <div className="viewer">
      {showChannelName && currentChannel ? (
        <div className="channelNameContainer">
          <h1>{currentChannel?.properties.name}</h1>
        </div>
      ) : null}
      {currentClients?.map((client, i) => {
        //* Client limit
        if (clientLimit != 0 && i >= clientLimit) {
          return null;
        }

        if (client) {
          //* Non-talking client
          if (hideNonTalking && (client.properties.inputMuted || client.properties.outputMuted || client.talkStatus == 0)) {
            return null;
          }

          //* Normal client
          return (
            <div className="client" key={`${client.id}-${client.channel?.connection.id}`}>
              {client.properties.outputHardware == false ? (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
                  <title>muted_hardware_output</title>
                  <g id="muted_hardware_output.svg">
                    <path
                      d="M116.62,39a4.78,4.78,0,0,1-1.59.3l-6.29,3.63a45.42,45.42,0,0,1-13.33,57.64,49.4,49.4,0,0,1-5.82,3.62c-1.06.57-2.2.92-3.19,1.49-1.7,1-2.77,2.13-2.77,4.18a4.57,4.57,0,0,0,4.54,4.54,5.33,5.33,0,0,0,1.84-.35,54.49,54.49,0,0,0,26.94-75c-.12,0-.22,0-.34,0M88.18,13.58a4.57,4.57,0,0,0-4.54,4.54c0,2.06,1.06,3.19,2.77,4.18,1,.57,2.13.92,3.19,1.49a49.4,49.4,0,0,1,5.82,3.62,45.68,45.68,0,0,1,8.19,7.78l7-4a2.63,2.63,0,0,1,1.11-.34A54.31,54.31,0,0,0,90,13.94a5.33,5.33,0,0,0-1.84-.35"
                      fill="#d8d8d8"
                    />
                    <path
                      d="M59.46,71.4,32.77,86.81l19,19a4.51,4.51,0,0,0,3.19,1.35,4.57,4.57,0,0,0,4.54-4.54V71.4M54.92,20.88a4.51,4.51,0,0,0-3.19,1.35L28.12,45.85H9.54A4.57,4.57,0,0,0,5,50.38V77.62a4.57,4.57,0,0,0,4.54,4.54H22.26l37.2-21.48V25.42a4.57,4.57,0,0,0-4.54-4.54"
                      fill="#d8d8d8"
                    />
                    <path
                      d="M85.11,56.6l-7.87,4.54A10,10,0,0,1,77.62,64c0,8.58-8.23,7.09-8.23,12.48A4.53,4.53,0,0,0,73.93,81a4,4,0,0,0,1.77-.35A18.13,18.13,0,0,0,86.69,64a18.34,18.34,0,0,0-1.59-7.4M73.93,47a4.52,4.52,0,0,0-4.54,4.54,3.92,3.92,0,0,0,1.08,2.8l8.76-5.06a16.14,16.14,0,0,0-3.52-1.93A4,4,0,0,0,73.93,47"
                      fill="#d8d8d8"
                    />
                    <path
                      d="M100.87,47.49,93,52a27.15,27.15,0,0,1-8.36,33.87A36.79,36.79,0,0,1,79.25,89a4.54,4.54,0,0,0,1.84,8.72,5.24,5.24,0,0,0,1.77-.35,36.34,36.34,0,0,0,18-49.91M81,30.25A4.54,4.54,0,0,0,79.25,39a36.82,36.82,0,0,1,5.39,3.12,27,27,0,0,1,2.86,2.4l8.14-4.7A35.37,35.37,0,0,0,82.86,30.6,5.31,5.31,0,0,0,81,30.25"
                      fill="#d8d8d8"
                    />
                    <path
                      d="M126.57,43.71,10.42,110.77a2.88,2.88,0,0,1-3.93-1.05L4.33,106A2.88,2.88,0,0,1,5.38,102L121.53,35A2.88,2.88,0,0,1,125.46,36l2.16,3.75A2.88,2.88,0,0,1,126.57,43.71Z"
                      fill="#c9070a"
                    />
                  </g>
                </svg>
              ) : client.properties.inputHardware == false ? (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
                  <title>muted_hardware_input</title>
                  <g id="muted_hardware_input.svg">
                    <path
                      d="M88.62,54.15V64A24.69,24.69,0,0,1,64,88.62a25.26,25.26,0,0,1-8.38-1.46l-7.39,7.39A34,34,0,0,0,64,98.46,34.5,34.5,0,0,0,98.46,64V54.15a4.92,4.92,0,1,1,9.85,0V64a44.31,44.31,0,0,1-39.38,44v10.15H88.62a4.92,4.92,0,0,1,0,9.85H39.38a4.92,4.92,0,1,1,0-9.85H59.08V108A43.3,43.3,0,0,1,41,101.77L21.46,121.31a2.46,2.46,0,0,1-3.54,0L11.62,115a2.46,2.46,0,0,1,0-3.54l94.92-94.92a2.46,2.46,0,0,1,3.54,0l6.31,6.31a2.46,2.46,0,0,1,0,3.54ZM22.92,80.46A43.3,43.3,0,0,1,19.69,64V54.15a4.92,4.92,0,1,1,9.85,0V64a35.94,35.94,0,0,0,1.15,8.69ZM39.38,64V24.62a24.62,24.62,0,0,1,47.77-8.38Z"
                      fill="#d8d8d8"
                    />
                    <rect x="-5.93" y="61.89" width="139.87" height="14.02" rx="2.87" ry="2.87" transform="translate(-29.97 65.43) rotate(-45)" fill="#c9070a" />
                  </g>
                </svg>
              ) : client.properties.outputMuted ? (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
                  <title>muted_output</title>
                  <g id="muted_output">
                    <path
                      d="M116.62,39a4.78,4.78,0,0,1-1.59.3l-6.29,3.63a45.42,45.42,0,0,1-13.33,57.64,49.4,49.4,0,0,1-5.82,3.62c-1.06.57-2.2.92-3.19,1.49-1.7,1-2.77,2.13-2.77,4.18a4.57,4.57,0,0,0,4.54,4.54,5.33,5.33,0,0,0,1.84-.35,54.49,54.49,0,0,0,26.94-75c-.12,0-.22,0-.34,0M88.18,13.58a4.57,4.57,0,0,0-4.54,4.54c0,2.06,1.06,3.19,2.77,4.18,1,.57,2.13.92,3.19,1.49a49.4,49.4,0,0,1,5.82,3.62,45.68,45.68,0,0,1,8.19,7.78l7-4a2.63,2.63,0,0,1,1.11-.34A54.31,54.31,0,0,0,90,13.94a5.33,5.33,0,0,0-1.84-.35"
                      fill="#c9070a"
                    />
                    <path
                      d="M59.46,71.4,32.77,86.81l19,19a4.51,4.51,0,0,0,3.19,1.35,4.57,4.57,0,0,0,4.54-4.54V71.4M54.92,20.88a4.51,4.51,0,0,0-3.19,1.35L28.11,45.85H9.53A4.57,4.57,0,0,0,5,50.38V77.62a4.57,4.57,0,0,0,4.54,4.54H22.25l37.2-21.48V25.42a4.57,4.57,0,0,0-4.54-4.54"
                      fill="#c9070a"
                    />
                    <path
                      d="M85.1,56.6l-7.87,4.54A10,10,0,0,1,77.61,64c0,8.58-8.23,7.09-8.23,12.48A4.53,4.53,0,0,0,73.92,81a4,4,0,0,0,1.77-.35A18.13,18.13,0,0,0,86.69,64a18.34,18.34,0,0,0-1.59-7.4M73.92,47a4.52,4.52,0,0,0-4.54,4.54,3.92,3.92,0,0,0,1.08,2.8l8.76-5.06a16.14,16.14,0,0,0-3.52-1.93A4,4,0,0,0,73.92,47"
                      fill="#c9070a"
                    />
                    <path
                      d="M100.87,47.49,93,52a27.15,27.15,0,0,1-8.36,33.87A36.79,36.79,0,0,1,79.24,89a4.54,4.54,0,0,0,1.84,8.72,5.24,5.24,0,0,0,1.77-.35,36.34,36.34,0,0,0,18-49.91M81,30.25A4.54,4.54,0,0,0,79.24,39a36.82,36.82,0,0,1,5.39,3.12,27,27,0,0,1,2.86,2.4l8.14-4.7A35.37,35.37,0,0,0,82.86,30.6,5.31,5.31,0,0,0,81,30.25"
                      fill="#c9070a"
                    />
                    <path
                      d="M126.57,43.71,10.42,110.77a2.88,2.88,0,0,1-3.93-1.05L4.33,106A2.88,2.88,0,0,1,5.38,102L121.53,35A2.88,2.88,0,0,1,125.46,36l2.16,3.75A2.88,2.88,0,0,1,126.57,43.71Z"
                      fill="#c9070a"
                    />
                  </g>
                </svg>
              ) : client.properties.inputMuted ? (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
                  <title>muted_input</title>
                  <g id="muted_input.svg">
                    <path
                      d="M88.62,54.15V64A24.69,24.69,0,0,1,64,88.62a25.26,25.26,0,0,1-8.38-1.46l-7.39,7.39A34,34,0,0,0,64,98.46,34.5,34.5,0,0,0,98.46,64V54.15a4.92,4.92,0,1,1,9.85,0V64a44.31,44.31,0,0,1-39.38,44v10.15H88.62a4.92,4.92,0,0,1,0,9.85H39.38a4.92,4.92,0,1,1,0-9.85H59.08V108A43.3,43.3,0,0,1,41,101.77L21.46,121.31a2.46,2.46,0,0,1-3.54,0L11.62,115a2.46,2.46,0,0,1,0-3.54l94.92-94.92a2.46,2.46,0,0,1,3.54,0l6.31,6.31a2.46,2.46,0,0,1,0,3.54ZM22.92,80.46A43.3,43.3,0,0,1,19.69,64V54.15a4.92,4.92,0,1,1,9.85,0V64a35.94,35.94,0,0,0,1.15,8.69ZM39.38,64V24.62a24.62,24.62,0,0,1,47.77-8.38Z"
                      fill="#c9070a"
                    />
                  </g>
                </svg>
              ) : client.talkStatus == 1 ? (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
                  <title>player_on_v2</title>
                  <g id="player_on_v2.svg">
                    <path d="M64,128a64,64,0,1,1,64-64A64,64,0,0,1,64,128Z" fill="#00b4df" />
                  </g>
                </svg>
              ) : (
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:serif="http://www.serif.com/" width="100%" height="100%" viewBox="0 0 135 128" version="1.1" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <circle cx="27.371" cy="59.999" r="20.15" style="fill:url(#_Linear1);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <path d="M27.371,39.849C38.492,39.849 47.521,48.878 47.521,59.999C47.521,71.12 38.492,80.149 27.371,80.149C16.25,80.149 7.221,71.12 7.221,59.999C7.221,48.878 16.25,39.849 27.371,39.849ZM27.371,41.108C37.797,41.108 46.262,49.573 46.262,59.999C46.262,70.425 37.797,78.889 27.371,78.889C16.945,78.889 8.481,70.425 8.481,59.999C8.481,49.573 16.945,41.108 27.371,41.108Z" style="fill:url(#_Linear2);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <circle cx="27.371" cy="59.999" r="15.112" style="fill:rgb(77,202,237);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <circle cx="27.371" cy="59.999" r="13.853" style="fill:url(#_Linear3);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <circle cx="27.371" cy="59.999" r="10.39" style="fill:rgb(183,189,210);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <path d="M51.492,23.136C52.055,23.482 52.56,23.855 52.988,24.252C58.328,29.209 60.969,34.075 62.45,40.841C63.758,46.819 64.386,49.714 61.244,51.894C57.003,54.837 65.775,67.412 67.486,71.051C65.225,73.951 62.277,73.888 60.719,74.692C59.855,75.137 60.212,76.786 60.352,78.056C60.489,79.299 61.634,80.081 61.006,81.044C60.443,81.907 58.316,81.969 57.392,82.563C58.281,83.542 60.258,84.524 59.998,85.797C59.798,86.78 57.58,86.607 56.726,88.845C56.268,90.044 56.504,92.268 55.558,93.391C54.126,95.089 52.65,95.867 50.53,96.062C49.396,96.183 48.249,96.064 47.164,95.711C43.639,94.552 40.362,92.885 37.407,90.808C38.618,91.011 39.935,91.201 41.323,91.355C45.347,91.802 47.369,91.416 49.301,89.124C50.133,88.137 49.925,86.182 50.328,85.127C51.079,83.16 53.029,83.312 53.205,82.447C53.434,81.328 51.696,80.465 50.914,79.603C51.726,79.082 53.597,79.027 54.092,78.268C54.644,77.421 53.637,76.734 53.517,75.64C53.394,74.524 53.079,73.074 53.839,72.683C55.209,71.976 57.801,72.032 59.789,69.482C58.285,66.282 50.572,55.225 54.301,52.637C57.064,50.721 56.511,48.175 55.361,42.919C54.059,36.97 51.736,32.691 47.041,28.332C46.028,27.392 44.526,26.606 42.852,26.029C45.578,24.729 48.476,23.75 51.492,23.136Z" style="fill:url(#_Linear4);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <path d="M60,22.399C60.797,22.421 61.598,22.468 62.402,22.541C83.079,24.419 98.341,42.731 96.463,63.407C94.731,82.479 79.017,96.945 60.361,97.601C60.628,97.391 60.883,97.164 61.124,96.916C62.719,95.275 63.023,93.301 63.299,91.286C63.443,90.265 64.212,90.188 64.868,89.81C67.714,88.168 66.506,84.377 66.506,84.377C67.337,83.742 67.932,82.812 68.112,81.792C68.366,80.353 67.391,79.119 67.186,77.466C67.582,77.354 67.978,77.24 68.369,77.112C71.569,76.063 75.953,73.518 74.295,70.078C72.454,66.259 69.898,62.651 68.222,58.683C67.567,57.133 66.821,55.568 67.074,54.137C70.193,51.892 70.841,48.246 70.392,44.947C69.207,36.219 65.877,28.318 60,22.399Z" style="fill:rgb(209,209,224);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <path d="M68.669,27.944C73.732,29.842 78.374,32.733 82.113,36.597C89.237,43.961 93.475,54.665 91.42,64.643C89.475,74.089 81.275,81.96 75.842,84.384C73.241,85.545 71.132,85.375 71.146,85.059C71.16,84.743 71.49,84.08 73.119,82.117C78.947,75.089 82.379,64.825 77.257,56.81C76.219,55.184 74.946,53.81 73.509,52.638C74.662,50.467 74.86,47.912 74.536,45.522C73.668,39.135 71.757,33.152 68.669,27.944Z" style="fill:url(#_Linear5);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <path d="M58.106,8.281C39.803,18.267 27.371,37.693 27.371,59.999C27.371,63.531 27.683,66.991 28.28,70.349C27.981,70.375 27.678,70.389 27.371,70.389C21.637,70.389 16.981,65.733 16.981,59.999C16.981,42.767 23.287,26.997 33.717,14.871C40.953,10.806 49.261,8.431 58.106,8.281Z" style="fill:url(#_Linear6);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <path d="M33.716,14.871C41.196,10.669 49.82,8.273 59,8.273C87.551,8.273 110.731,31.453 110.731,60.005C110.731,87.652 85.623,113.158 48.293,104.995L48.208,104.923C70.543,107.297 87.006,98.2 95.932,84.908L95.986,84.827C100.759,77.734 103.546,69.192 103.546,60.005L103.546,59.999C103.542,35.415 83.583,15.458 59,15.458C42.902,15.458 28.787,24.015 20.96,36.825C23.847,28.703 28.207,21.277 33.716,14.871Z" style="fill:rgb(148,162,193);"/>
    </g>
    <g transform="matrix(1.30256,0,0,1.30256,-9.40579,-10.7761)">
        <path d="M59,8.273C87.551,8.273 110.731,31.453 110.731,60.005C110.731,71.086 106.698,81.823 99.459,90.187C105.754,81.765 109.483,71.317 109.483,60.005C109.483,32.142 86.862,9.521 59,9.521C48.799,9.521 39.301,12.553 31.362,17.762C32.121,16.777 32.906,15.813 33.716,14.871C36.87,13.1 40.227,11.649 43.743,10.563L43.758,10.559L44.138,10.443L44.143,10.442L44.534,10.326L44.925,10.214L44.937,10.211L45.303,10.109L45.342,10.098L45.721,9.996C45.853,9.962 45.986,9.927 46.119,9.892L46.494,9.798L46.549,9.784L46.888,9.701L46.934,9.69L47.32,9.599L47.705,9.512L47.76,9.5L48.086,9.429L48.161,9.413L48.509,9.34L48.539,9.333L48.932,9.254L48.962,9.248L49.307,9.181L49.395,9.165L49.701,9.108L49.782,9.094L50.164,9.026L50.546,8.962L50.633,8.948L50.93,8.9L51.033,8.884L51.35,8.836L51.414,8.826L51.799,8.771L51.865,8.762L52.18,8.72L52.291,8.705L52.576,8.669L52.68,8.656L53.062,8.611L53.444,8.569L53.552,8.557L53.833,8.529L53.953,8.517L54.254,8.489L54.338,8.481L54.721,8.448L54.806,8.441L55.107,8.418L55.231,8.409L55.508,8.39L55.623,8.382L56.008,8.358L56.394,8.338L56.511,8.332L56.788,8.32L56.915,8.315L57.214,8.304L57.306,8.3L57.692,8.289L57.784,8.287L58.084,8.281L58.212,8.279L58.49,8.276L58.61,8.275L59,8.273Z" style="fill:rgb(183,189,210);"/>
    </g>
    <defs>
        <linearGradient id="_Linear1" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(2.46766e-15,-40.3,40.3,2.46766e-15,27.3713,80.1487)"><stop offset="0" style="stop-color:rgb(75,105,182);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(67,94,165);stop-opacity:1"/></linearGradient>
        <linearGradient id="_Linear2" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(5.28351e-07,-40.3,40.3,5.28351e-07,27.3713,80.1487)"><stop offset="0" style="stop-color:rgb(87,115,187);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(58,82,144);stop-opacity:1"/></linearGradient>
        <linearGradient id="_Linear3" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(9.39767e-14,-27.7062,27.7062,9.39767e-14,27.3713,73.8518)"><stop offset="0" style="stop-color:rgb(34,178,231);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(23,122,158);stop-opacity:1"/></linearGradient>
        <linearGradient id="_Linear4" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(4.43868e-15,-72.4891,72.4891,4.43868e-15,53.9789,94.874)"><stop offset="0" style="stop-color:rgb(75,105,182);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(67,94,165);stop-opacity:1"/></linearGradient>
        <linearGradient id="_Linear5" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(3.33779e-15,-54.5103,54.5103,3.33779e-15,74.6579,85.2923)"><stop offset="0" style="stop-color:rgb(167,177,205);stop-opacity:1"/><stop offset="0.46" style="stop-color:rgb(200,203,220);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(209,210,224);stop-opacity:1"/></linearGradient>
        <linearGradient id="_Linear6" x1="0" y1="0" x2="1" y2="0" gradientUnits="userSpaceOnUse" gradientTransform="matrix(19.4796,-60.8492,60.8492,19.4796,28.28,70.3492)"><stop offset="0" style="stop-color:rgb(183,189,210);stop-opacity:1"/><stop offset="1" style="stop-color:rgb(96,123,182);stop-opacity:1"/></linearGradient>
    </defs>
</svg>
              )}
              <p>{client.properties.nickname}</p>
            </div>
          );
        } else {
          return <div key={Math.random()}></div>;
        }
      })}
      {currentChannel == null ? (
        <>
          <h4>Overlay couldn't connect to the client:</h4>
          <br />
          <br />
          <h5>1. Make sure to accept the overlay in your TS5-Client via the notifications</h5>
          <br />
          <h5>2. Enable remote apps inside the the TS5-Settings</h5>
          <br />
          <h5>3. Make sure to match the configuration port with the port in the TS5 remote app settings</h5>
          <br />
          <h5>4. Refresh this page/BrowserSource (Select BrowserSource & click "Refresh" in OBS)</h5>
          <br />
          <h6>If non of this worked refer to the GitHub and write an issue with your problem</h6>
        </>
      ) : (
        ""
      )}
    </div>
  );
}
